{{ 'wishlist.css' | asset_url | stylesheet_tag }}
<script src="{{ 'wishlist.js' | asset_url }}" defer></script>
{% style %}
  .section-{{ section.id }}-padding {
    padding-top: {{ section.settings.padding_top }}px;
    padding-bottom: {{ section.settings.padding_top }}px;
  }
  @media (max-width: 768px) {
    .section-{{ section.id }}-padding {
      padding-top: {{ section.settings.padding_top | times: 0.55 |  round }}px;
      padding-bottom: {{ section.settings.padding_top | times: 0.55 | round }}px;
    }
  }
{% endstyle %}


<div class="section-{{ section.id }}-padding wishlist color-{{ section.settings.section_color_scheme }} gradient" id="wishlist-sec">
  <div class="page-width">
    <h1>Minha Lista de Desejos</h1>

    <div class="wrapper-title">
    <p>Infelizmente nenhum produto foi adicionado :(</p>
    </div>
   

  <wishlist-products 
    data-section-id="{{ section.id }}">
  </wishlist-products>
  </div>
</div>

<wishlist-products data-section-id="{{ section.id }}"></wishlist-products>

<script>
class WishlistProducts extends HTMLElement {
  constructor() {
    super();
    this.sectionId = this.dataset.sectionId;
    this.container = document.createElement("div");
    this.container.classList.add("wishlist-products-wrapper");
    this.appendChild(this.container);
  }

  connectedCallback() {
    this.loadWishlist();
  }

  async loadWishlist() {
    const stored = localStorage.getItem("wishlist");
    let handles = [];

    try {
      handles = stored ? JSON.parse(stored) : [];
    } catch (e) {
      console.error("Wishlist inválida", e);
    }

    if (!handles.length) {
      this.container.innerHTML = `<p class="empty-wishlist">Sua lista está vazia.</p>`;
      return;
    } else {
        document.querySelector('.wrapper-title').classList.add('hidden')
    }

    const products = await Promise.all(
      handles.map(async (handle) => {
        try {
          const res = await fetch(`/products/${handle}.js`);
          if (!res.ok) throw new Error("Produto não encontrado");
          return await res.json();
        } catch (err) {
          console.error("Erro carregando", handle, err);
          return null;
        }
      })
    );

    const validProducts = products.filter((p) => p);

    this.renderProducts(validProducts);
  }

  renderProducts(products) {
    this.container.innerHTML = "";

    products.forEach((product) => {
      const card = document.createElement("div");
      card.classList.add("wishlist-card");

      card.innerHTML = `
        <div class="wishlist-card__image">
          <a href="${product.url}">
            <img src="${product.featured_image}" alt="${product.title}">
          </a>
        </div>

        <div class="wishlist-card__info">
          <h3 class="wishlist-card__title">
            <a href="${product.url}">${product.title}</a>
          </h3>

          <div class="wishlist-card__price">
            ${this.formatPrice(product.price)}
          </div>

          <button class="wishlist-remove" data-handle="${product.handle}">
            Remover
          </button>
        </div>
      `;

      card
        .querySelector(".wishlist-remove")
        .addEventListener("click", (e) => this.removeFromWishlist(e));

      this.container.appendChild(card);
    });
  }

  removeFromWishlist(e) {
    const handle = e.target.dataset.handle;
    const stored = JSON.parse(localStorage.getItem("wishlist") || "[]");
    const newList = stored.filter((h) => h !== handle);
    localStorage.setItem("wishlist", JSON.stringify(newList));

    this.loadWishlist();
  }

  formatPrice(cents) {
    return (cents / 100).toLocaleString("pt-BR", {
      style: "currency",
      currency: "BRL"
    });
  }
}

customElements.define("wishlist-products", WishlistProducts);
</script>


{% schema %}
  {
    "name": "Wishlist",
    "settings": [
      {
        "type": "header",
        "content": "Cores"
      },
      {
        "type": "color_scheme",
        "id": "section_color_scheme",
        "label": "t:sections.all.colors.label",
        "default": "scheme-1"
      },
      {
        "type": "header",
        "content": "t:sections.all.padding.section_padding_heading"
      },
      {
        "type": "range",
        "id": "padding_top",
        "min": 0,
        "max": 100,
        "step": 4,
        "unit": "px",
        "label": "t:sections.all.padding.padding_top",
        "default": 36
      }, {
        "type": "range",
        "id": "padding_bottom",
        "min": 0,
        "max": 100,
        "step": 4,
        "unit": "px",
        "label": "t:sections.all.padding.padding_bottom",
        "default": 36
      }
    ],
    "presets": [
      {
        "name": "Wishlist"
      }
    ]
  }
{% endschema %}